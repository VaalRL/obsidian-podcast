# 00｜開發環境設定（Development Setup）

> 適用於 Obsidian Podcast Player 插件開發

## 開發理念

**所有開發與測試都在 Test Vault 中進行**，以確保：
- 貼近使用者實際使用狀態
- 即時測試插件功能
- 快速發現與修正問題
- 真實的 Obsidian 環境測試

---

## Test Vault 結構

```
obsidian-podcast-player/
├── src/                          # 源碼目錄
├── Test Vault/                   # 測試 Vault（開發環境）
│   ├── .obsidian/
│   │   └── plugins/
│   │       └── podcast-player/  # 插件安裝位置（構建輸出）
│   │           ├── main.js      # 編譯後的插件主檔案
│   │           ├── manifest.json
│   │           └── styles.css
│   ├── Podcasts/                # 測試用 Podcast 筆記
│   ├── Templates/               # 測試用模板
│   └── Test Notes.md            # 測試筆記
├── manifest.json                 # 插件清單（源檔案）
├── package.json
├── tsconfig.json
└── esbuild.config.mjs           # 構建配置（輸出到 Test Vault）
```

---

## 開發流程

### 1. 初始設定

```bash
# 安裝依賴
npm install

# 建立 Test Vault 插件目錄
mkdir -p "Test Vault/.obsidian/plugins/podcast-player"

# 複製 manifest.json 到 Test Vault
cp manifest.json "Test Vault/.obsidian/plugins/podcast-player/"
```

### 2. 開發模式（熱重載）

```bash
# 啟動開發模式（監聽檔案變更，自動編譯）
npm run dev
```

**工作流程**：
1. 修改 `src/` 目錄中的源碼
2. esbuild 自動偵測變更並重新編譯
3. 編譯輸出到 `Test Vault/.obsidian/plugins/podcast-player/`
4. 在 Obsidian 中重新載入插件（Ctrl/Cmd + R）
5. 立即測試變更

### 3. 生產構建

```bash
# 完整構建（包含優化）
npm run build

# 構建並複製到 Test Vault
npm run build:test
```

### 4. 測試

```bash
# 執行單元測試
npm test

# 執行測試並監聽變更
npm run test:watch

# 測試覆蓋率報告
npm run test:coverage
```

---

## esbuild 配置

`esbuild.config.mjs` 配置範例：

```javascript
import esbuild from 'esbuild';
import process from 'process';
import fs from 'fs';

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
*/
`;

const prod = process.argv[2] === 'production';
const testVaultPath = 'Test Vault/.obsidian/plugins/podcast-player';

// 確保輸出目錄存在
if (!fs.existsSync(testVaultPath)) {
  fs.mkdirSync(testVaultPath, { recursive: true });
}

const context = await esbuild.context({
  banner: {
    js: banner,
  },
  entryPoints: ['main.ts'],
  bundle: true,
  external: [
    'obsidian',
    'electron',
    '@codemirror/autocomplete',
    '@codemirror/collab',
    '@codemirror/commands',
    '@codemirror/language',
    '@codemirror/lint',
    '@codemirror/search',
    '@codemirror/state',
    '@codemirror/view',
    '@lezer/common',
    '@lezer/highlight',
    '@lezer/lr',
  ],
  format: 'cjs',
  target: 'es2018',
  logLevel: 'info',
  sourcemap: prod ? false : 'inline',
  treeShaking: true,
  outfile: `${testVaultPath}/main.js`,
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
```

**重點**：
- `outfile` 直接輸出到 Test Vault
- 開發模式啟用 `sourcemap` 方便除錯
- 生產模式關閉 `sourcemap` 減少檔案大小

---

## package.json 腳本

```json
{
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "node esbuild.config.mjs production",
    "build:test": "npm run build && npm run copy:test",
    "copy:test": "cp manifest.json styles.css 'Test Vault/.obsidian/plugins/podcast-player/'",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  }
}
```

---

## Test Vault 使用

### 在 Obsidian 中啟用插件

1. 開啟 `Test Vault` 作為 Vault
2. 開啟設定 → 社群插件
3. 關閉「安全模式」
4. 在已安裝插件中找到「Podcast Player」
5. 啟用插件

### 重新載入插件

**開發時經常需要**：
- **方法一**（推薦）：使用命令面板 → "Reload app without saving"
- **方法二**：Ctrl/Cmd + R（重新載入 Obsidian）
- **方法三**：關閉後重新啟用插件

### 測試資料準備

在 Test Vault 中準備：

1. **測試 Podcast 訂閱**
   - 使用真實的 RSS Feed（如 https://feeds.buzzsprout.com/...）
   - 建立測試用的 Podcast 筆記

2. **範例筆記**
   - `Test Notes.md` - 測試快速匯入功能
   - `Podcasts/` 資料夾 - 存放 Podcast 筆記

3. **測試資料檔案**
   - `.obsidian/plugins/podcast-player/data/` - 插件資料目錄
   - 預先建立一些測試資料

---

## 除錯

### 使用開發者工具

1. 在 Obsidian 中按 `Ctrl/Cmd + Shift + I` 開啟開發者工具
2. Console 面板查看日誌
3. Sources 面板設定中斷點（需要 sourcemap）
4. 使用 `console.log()` 輸出除錯訊息

### 常見問題

**Q: 修改程式碼後沒有生效？**
- 確認 `npm run dev` 正在執行
- 確認編譯成功（檢查終端輸出）
- 在 Obsidian 中重新載入插件

**Q: 插件無法載入？**
- 檢查 `manifest.json` 格式是否正確
- 檢查開發者工具 Console 的錯誤訊息
- 確認 `main.js` 已成功編譯

**Q: 找不到 Test Vault？**
- 確認路徑：`Test Vault/.obsidian/plugins/podcast-player/`
- 檢查目錄權限

---

## 最佳實踐

### 1. 頻繁測試
- 每完成一個小功能就在 Test Vault 中測試
- 不要累積太多變更才測試

### 2. 真實場景測試
- 使用真實的 Podcast Feed
- 模擬使用者操作流程
- 測試各種邊界情況

### 3. 保持 Test Vault 整潔
- 定期清理測試資料
- 保留有代表性的測試案例
- Git 忽略測試資料（但保留結構）

### 4. 版本控制
```gitignore
# Test Vault - 忽略使用者資料，保留結構
Test Vault/.obsidian/workspace.json
Test Vault/.obsidian/workspace-mobile.json
Test Vault/.obsidian/plugins/podcast-player/data/
Test Vault/**/*.md
!Test Vault/README.md

# 保留插件編譯輸出（方便測試）
!Test Vault/.obsidian/plugins/podcast-player/main.js
!Test Vault/.obsidian/plugins/podcast-player/manifest.json
!Test Vault/.obsidian/plugins/podcast-player/styles.css
```

### 5. 快速迭代循環
```
修改程式碼 → 自動編譯 → Obsidian 重載 → 測試 → 修改程式碼 → ...
```

---

## 常用命令快速參考

```bash
# 初始化開發環境
npm install
mkdir -p "Test Vault/.obsidian/plugins/podcast-player"
npm run copy:test

# 開始開發
npm run dev

# 在另一個終端執行測試
npm run test:watch

# 完成功能後
npm run build
npm test
git add .
git commit -m "feat: 新增功能"
```

---

## 相關文件

- [01_前置檢查清單](./01_前置檢查清單_Preflight-Checklist.md)
- [04_程式品質與測試](./04_程式品質與測試_TDD.md)
- [06_工具使用與限制](./06_工具使用與限制_Tooling.md)
