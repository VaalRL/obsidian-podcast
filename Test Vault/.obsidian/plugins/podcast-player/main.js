/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var T=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var W=Object.prototype.hasOwnProperty;var J=(c,t)=>{for(var e in t)T(c,e,{get:t[e],enumerable:!0})},_=(c,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of j(t))!W.call(c,i)&&i!==e&&T(c,i,{get:()=>t[i],enumerable:!(a=H(t,i))||a.enumerable});return c};var z=c=>_(T({},"__esModule",{value:!0}),c);var K={};J(K,{default:()=>F});module.exports=z(K);var y=require("obsidian");var g={dataFolderPath:".obsidian/plugins/podcast-player/data",defaultPlaybackSettings:{volume:1,playbackSpeed:1,skipIntroSeconds:0,skipOutroSeconds:0},autoDownload:!1,maxCacheEpisodes:50,feedUpdateInterval:60,enableNotifications:!0};var p=require("obsidian");var A=class c{constructor(){this.logLevel=1;this.prefix="[Podcast Player]"}static getInstance(){return c.instance||(c.instance=new c),c.instance}setLogLevel(t){this.logLevel=t}getLogLevel(){return this.logLevel}debug(t,...e){this.logLevel<=0&&console.debug(`${this.prefix} [DEBUG]`,t,...e)}info(t,...e){this.logLevel<=1&&console.info(`${this.prefix} [INFO]`,t,...e)}warn(t,...e){this.logLevel<=2&&console.warn(`${this.prefix} [WARN]`,t,...e)}error(t,e,...a){this.logLevel<=3&&(e instanceof Error?console.error(`${this.prefix} [ERROR]`,t,e.message,e.stack,...a):console.error(`${this.prefix} [ERROR]`,t,e,...a))}methodEntry(t,e,...a){this.debug(`${t}.${e}() called`,...a)}methodExit(t,e,a){this.debug(`${t}.${e}() completed`,a)}},s=A.getInstance();var q=require("obsidian"),M=class extends Error{constructor(e,a){super(e);this.code=a;this.name="PodcastPlayerError"}};var d=class extends M{constructor(e,a){super(e,"STORAGE_ERROR");this.path=a;this.name="StorageError"}};function V(c,t){try{return JSON.parse(c)}catch(e){return s.warn("Failed to parse JSON",e),t}}var S=class{constructor(t,e){this.vault=t,this.basePath=(0,p.normalizePath)(e),this.structure=this.buildStructure()}buildStructure(){return{root:this.basePath,subscriptions:(0,p.normalizePath)(`${this.basePath}/subscriptions`),progress:(0,p.normalizePath)(`${this.basePath}/progress`),playlists:(0,p.normalizePath)(`${this.basePath}/playlists`),queues:(0,p.normalizePath)(`${this.basePath}/queues`),cache:(0,p.normalizePath)(`${this.basePath}/cache`),cacheFeed:(0,p.normalizePath)(`${this.basePath}/cache/feeds`),cacheImages:(0,p.normalizePath)(`${this.basePath}/cache/images`),backups:(0,p.normalizePath)(`${this.basePath}/backups`)}}getStructure(){return{...this.structure}}getBasePath(){return this.basePath}updateBasePath(t){this.basePath=(0,p.normalizePath)(t),this.structure=this.buildStructure()}async ensureDirectories(){s.info("Ensuring data directories exist",this.basePath);try{let t=this.vault.adapter;await t.exists(this.basePath)||(s.info("Creating base directory",this.basePath),await t.mkdir(this.basePath));let e=[this.structure.subscriptions,this.structure.progress,this.structure.playlists,this.structure.queues,this.structure.cache,this.structure.cacheFeed,this.structure.cacheImages,this.structure.backups];for(let a of e)await t.exists(a)||(s.debug("Creating directory",a),await t.mkdir(a));s.info("Data directories ready")}catch(t){throw s.error("Failed to create data directories",t),new d("Failed to create data directories",this.basePath)}}getFilePath(t,e){let a=this.structure[t];return(0,p.normalizePath)(`${a}/${e}`)}async directoryExists(t){try{return await this.vault.adapter.exists(t)}catch(e){return s.error("Failed to check directory existence",e),!1}}async fileExists(t){try{return await this.vault.adapter.exists(t)}catch(e){return s.error("Failed to check file existence",e),!1}}async listFiles(t){let e=this.structure[t];try{let a=this.vault.adapter;return await a.exists(e)?(await a.list(e)).files:[]}catch(a){throw s.error("Failed to list files",a),new d(`Failed to list files in ${e}`,e)}}async deleteFile(t){try{await this.vault.adapter.remove(t),s.debug("Deleted file",t)}catch(e){throw s.error("Failed to delete file",e),new d(`Failed to delete file ${t}`,t)}}async createBackup(t,e){try{let a=await this.vault.adapter.read(t),i=new Date().toISOString().replace(/[:.]/g,"-"),r=e||`backup-${i}.json`,o=this.getFilePath("backups",r);return await this.vault.adapter.write(o,a),s.info("Created backup",o),o}catch(a){throw s.error("Failed to create backup",a),new d(`Failed to create backup of ${t}`,t)}}async cleanupOldBackups(t=5){try{let e=await this.listFiles("backups");if(e.length<=t)return;let a=await Promise.all(e.map(async r=>{let o=await this.vault.adapter.stat(r);return{file:r,mtime:(o==null?void 0:o.mtime)||0}}));a.sort((r,o)=>o.mtime-r.mtime);let i=a.slice(t);for(let{file:r}of i)await this.deleteFile(r),s.debug("Deleted old backup",r);s.info(`Cleaned up ${i.length} old backups`)}catch(e){s.error("Failed to cleanup old backups",e)}}async getDirectorySize(t){try{let e=await this.listFiles(t),a=0;for(let i of e){let r=await this.vault.adapter.stat(i);a+=(r==null?void 0:r.size)||0}return a}catch(e){return s.error("Failed to get directory size",e),0}}};var $=require("obsidian");var k=class{constructor(t,e,a="json"){this.vault=t,this.pathManager=e,this.format=a}async readJson(t,e){try{let a=this.vault.adapter;if(!await a.exists(t))return s.debug("File does not exist, returning fallback",t),e;let i=await a.read(t),r=V(i,e);return s.debug("Read JSON file",t),r}catch(a){throw s.error("Failed to read JSON file",a),new d(`Failed to read file ${t}`,t)}}async writeJson(t,e,a=!0){try{let i=this.vault.adapter;if(a&&await i.exists(t))try{await this.pathManager.createBackup(t)}catch(o){s.warn("Failed to create backup, continuing",o)}let r=JSON.stringify(e,null,2);await i.write(t,r),s.debug("Wrote JSON file",t)}catch(i){throw s.error("Failed to write JSON file",i),new d(`Failed to write file ${t}`,t)}}async deleteFile(t){try{await this.vault.adapter.remove(t),s.debug("Deleted file",t)}catch(e){throw s.error("Failed to delete file",e),new d(`Failed to delete file ${t}`,t)}}async fileExists(t){try{return await this.vault.adapter.exists(t)}catch(e){return s.error("Failed to check file existence",e),!1}}async listFiles(t){try{let e=this.vault.adapter;return await e.exists(t)?(await e.list(t)).files:[]}catch(e){throw s.error("Failed to list files",e),new d(`Failed to list files in ${t}`,t)}}},h=class extends k{constructor(t,e,a,i="json"){super(t,e,i),this.filePath=(0,$.normalizePath)(a)}async load(){s.methodEntry("SingleFileStore","load",this.filePath);let t=await this.readJson(this.filePath,this.getDefaultValue());return this.validate(t)?(s.methodExit("SingleFileStore","load"),t):(s.warn("Data validation failed, using default value",this.filePath),this.getDefaultValue())}async save(t){if(s.methodEntry("SingleFileStore","save",this.filePath),!this.validate(t))throw new d("Data validation failed",this.filePath);await this.writeJson(this.filePath,t),s.methodExit("SingleFileStore","save")}async clear(){s.methodEntry("SingleFileStore","clear",this.filePath);let t=this.getDefaultValue();await this.save(t),s.methodExit("SingleFileStore","clear")}async delete(){await this.fileExists(this.filePath)&&await this.deleteFile(this.filePath)}};var v=class v extends h{constructor(t,e){let a=e.getFilePath("subscriptions","subscriptions.json");super(t,e,a)}validate(t){if(!t||typeof t!="object")return s.warn("Invalid subscription data: not an object"),!1;if(!Array.isArray(t.podcasts))return s.warn("Invalid subscription data: podcasts is not an array"),!1;if(typeof t.version!="number")return s.warn("Invalid subscription data: version is not a number"),!1;for(let e of t.podcasts)if(!this.validatePodcast(e))return s.warn("Invalid podcast in subscription data",e),!1;return!0}validatePodcast(t){if(!t||typeof t!="object")return!1;let e=["id","title","feedUrl","subscribedAt"];for(let a of e)if(!(a in t))return s.warn(`Missing required field in podcast: ${a}`),!1;return!0}getDefaultValue(){return{podcasts:[],version:v.CURRENT_VERSION}}async getAllPodcasts(){s.methodEntry("SubscriptionStore","getAllPodcasts");let t=await this.load();return s.methodExit("SubscriptionStore","getAllPodcasts"),t.podcasts}async getPodcast(t){s.methodEntry("SubscriptionStore","getPodcast",t);let a=(await this.load()).podcasts.find(i=>i.id===t)||null;return s.methodExit("SubscriptionStore","getPodcast"),a}async getPodcastByFeedUrl(t){s.methodEntry("SubscriptionStore","getPodcastByFeedUrl",t);let a=(await this.load()).podcasts.find(i=>i.feedUrl===t)||null;return s.methodExit("SubscriptionStore","getPodcastByFeedUrl"),a}async addPodcast(t){if(s.methodEntry("SubscriptionStore","addPodcast",t.id),!this.validatePodcast(t))throw new d("Invalid podcast data",this.filePath);let e=await this.load(),a=e.podcasts.findIndex(i=>i.id===t.id);a!==-1?(s.warn("Podcast already exists, updating instead",t.id),e.podcasts[a]=t):e.podcasts.push(t),await this.save(e),s.methodExit("SubscriptionStore","addPodcast")}async updatePodcast(t){if(s.methodEntry("SubscriptionStore","updatePodcast",t.id),!this.validatePodcast(t))throw new d("Invalid podcast data",this.filePath);let e=await this.load(),a=e.podcasts.findIndex(i=>i.id===t.id);if(a===-1)throw new d(`Podcast not found: ${t.id}`,this.filePath);e.podcasts[a]=t,await this.save(e),s.methodExit("SubscriptionStore","updatePodcast")}async removePodcast(t){s.methodEntry("SubscriptionStore","removePodcast",t);let e=await this.load(),a=e.podcasts.findIndex(i=>i.id===t);if(a===-1){s.warn("Podcast not found, nothing to remove",t);return}e.podcasts.splice(a,1),await this.save(e),s.methodExit("SubscriptionStore","removePodcast")}async isSubscribed(t){return(await this.load()).podcasts.some(a=>a.id===t)}async isSubscribedByFeedUrl(t){return(await this.load()).podcasts.some(a=>a.feedUrl===t)}async getSubscriptionCount(){return(await this.load()).podcasts.length}async updatePodcastEpisodes(t,e){s.methodEntry("SubscriptionStore","updatePodcastEpisodes",t);let a=await this.load(),i=a.podcasts.find(r=>r.id===t);if(!i)throw new d(`Podcast not found: ${t}`,this.filePath);i.episodes=e,i.lastFetchedAt=new Date,await this.save(a),s.methodExit("SubscriptionStore","updatePodcastEpisodes")}async updatePodcastSettings(t,e){s.methodEntry("SubscriptionStore","updatePodcastSettings",t);let a=await this.load(),i=a.podcasts.find(r=>r.id===t);if(!i)throw new d(`Podcast not found: ${t}`,this.filePath);i.settings=e,await this.save(a),s.methodExit("SubscriptionStore","updatePodcastSettings")}async getPodcastsNeedingUpdate(t){let e=await this.load(),a=Date.now();return e.podcasts.filter(i=>{if(!i.lastFetchedAt)return!0;let r=new Date(i.lastFetchedAt).getTime();return a-r>=t})}async searchPodcasts(t){let e=await this.load(),a=t.toLowerCase();return e.podcasts.filter(i=>{var n;let r=i.title.toLowerCase().includes(a),o=(n=i.author)==null?void 0:n.toLowerCase().includes(a);return r||o})}async exportSubscriptions(){s.methodEntry("SubscriptionStore","exportSubscriptions");let t=await this.load();return s.methodExit("SubscriptionStore","exportSubscriptions"),t}async importSubscriptions(t,e=!1){if(s.methodEntry("SubscriptionStore","importSubscriptions",`replace=${e}`),!this.validate(t))throw new d("Invalid import data",this.filePath);if(e)await this.save(t);else{let i=[...(await this.load()).podcasts];for(let r of t.podcasts){let o=i.findIndex(n=>n.id===r.id);o!==-1?i[o]=r:i.push(r)}await this.save({podcasts:i,version:v.CURRENT_VERSION})}s.methodExit("SubscriptionStore","importSubscriptions")}};v.CURRENT_VERSION=1;var L=v;function N(c,t,e=30){return t<=0?!1:t-c<=e}var w=class w extends h{constructor(t,e){let a=e.getFilePath("progress","progress.json");super(t,e,a)}validate(t){if(!t||typeof t!="object")return s.warn("Invalid progress data: not an object"),!1;if(!Array.isArray(t.progress))return s.warn("Invalid progress data: progress is not an array"),!1;if(typeof t.version!="number")return s.warn("Invalid progress data: version is not a number"),!1;for(let e of t.progress)if(!this.validateProgress(e))return s.warn("Invalid progress entry in data",e),!1;return!0}validateProgress(t){if(!t||typeof t!="object")return!1;let e=["episodeId","podcastId","position","duration","lastPlayedAt"];for(let a of e)if(!(a in t))return s.warn(`Missing required field in progress: ${a}`),!1;return!(typeof t.position!="number"||t.position<0||typeof t.duration!="number"||t.duration<0||typeof t.completed!="boolean")}getDefaultValue(){return{progress:[],version:w.CURRENT_VERSION}}async getProgress(t){s.methodEntry("ProgressStore","getProgress",t);let a=(await this.load()).progress.find(i=>i.episodeId===t)||null;return s.methodExit("ProgressStore","getProgress"),a}async getPodcastProgress(t){s.methodEntry("ProgressStore","getPodcastProgress",t);let a=(await this.load()).progress.filter(i=>i.podcastId===t);return s.methodExit("ProgressStore","getPodcastProgress"),a}async getAllProgress(){s.methodEntry("ProgressStore","getAllProgress");let t=await this.load();return s.methodExit("ProgressStore","getAllProgress"),t.progress}async updateProgress(t){if(s.methodEntry("ProgressStore","updateProgress",t.episodeId),!this.validateProgress(t))throw new d("Invalid progress data",this.filePath);let e=await this.load(),a=e.progress.findIndex(i=>i.episodeId===t.episodeId);t.completed=N(t.position,t.duration),a!==-1?e.progress[a]=t:e.progress.push(t),await this.save(e),s.methodExit("ProgressStore","updateProgress")}async updatePosition(t,e,a,i){s.methodEntry("ProgressStore","updatePosition",t);let r=await this.getProgress(t),o={episodeId:t,podcastId:e,position:a,duration:i,lastPlayedAt:new Date,completed:N(a,i)};await this.updateProgress(o),s.methodExit("ProgressStore","updatePosition")}async markCompleted(t,e,a){s.methodEntry("ProgressStore","markCompleted",t);let i={episodeId:t,podcastId:e,position:a,duration:a,lastPlayedAt:new Date,completed:!0};await this.updateProgress(i),s.methodExit("ProgressStore","markCompleted")}async resetProgress(t){s.methodEntry("ProgressStore","resetProgress",t);let e=await this.load(),a=e.progress.findIndex(i=>i.episodeId===t);a!==-1&&(e.progress.splice(a,1),await this.save(e)),s.methodExit("ProgressStore","resetProgress")}async removeProgress(t){s.methodEntry("ProgressStore","removeProgress",t);let e=await this.load(),a=e.progress.findIndex(i=>i.episodeId===t);a!==-1&&(e.progress.splice(a,1),await this.save(e)),s.methodExit("ProgressStore","removeProgress")}async removePodcastProgress(t){s.methodEntry("ProgressStore","removePodcastProgress",t);let e=await this.load();e.progress=e.progress.filter(a=>a.podcastId!==t),await this.save(e),s.methodExit("ProgressStore","removePodcastProgress")}async getInProgressEpisodes(){return(await this.load()).progress.filter(e=>!e.completed&&e.position>0)}async getCompletedEpisodes(){return(await this.load()).progress.filter(e=>e.completed)}async getRecentlyPlayed(t=10){return[...(await this.load()).progress].sort((i,r)=>{let o=new Date(i.lastPlayedAt).getTime();return new Date(r.lastPlayedAt).getTime()-o}).slice(0,t)}async getCompletionPercentage(t){let e=await this.getProgress(t);return!e||e.duration<=0?0:Math.min(100,Math.max(0,e.position/e.duration*100))}async getTotalListeningTime(){return(await this.load()).progress.reduce((e,a)=>e+a.position,0)}async getPodcastStatistics(t){let e=await this.getPodcastProgress(t);return{totalEpisodes:e.length,completedEpisodes:e.filter(a=>a.completed).length,inProgressEpisodes:e.filter(a=>!a.completed&&a.position>0).length,totalListeningTime:e.reduce((a,i)=>a+i.position,0)}}async cleanupOldProgress(t=100){s.methodEntry("ProgressStore","cleanupOldProgress",`keepRecentCount=${t}`);let e=await this.load(),a=[...e.progress].sort((i,r)=>{let o=new Date(i.lastPlayedAt).getTime();return new Date(r.lastPlayedAt).getTime()-o});e.progress=a.slice(0,t),await this.save(e),s.methodExit("ProgressStore","cleanupOldProgress")}async exportProgress(){s.methodEntry("ProgressStore","exportProgress");let t=await this.load();return s.methodExit("ProgressStore","exportProgress"),t}async importProgress(t,e=!1){if(s.methodEntry("ProgressStore","importProgress",`replace=${e}`),!this.validate(t))throw new d("Invalid import data",this.filePath);if(e)await this.save(t);else{let i=[...(await this.load()).progress];for(let r of t.progress){let o=i.findIndex(n=>n.episodeId===r.episodeId);if(o!==-1){let n=new Date(i[o].lastPlayedAt).getTime();new Date(r.lastPlayedAt).getTime()>n&&(i[o]=r)}else i.push(r)}await this.save({progress:i,version:w.CURRENT_VERSION})}s.methodExit("ProgressStore","importProgress")}};w.CURRENT_VERSION=1;var R=w;var B=require("obsidian");var b=class extends h{constructor(t,e){let a=e.getFilePath("root","settings.json");super(t,e,a)}validate(t){if(!t||typeof t!="object")return s.warn("Invalid settings data: not an object"),!1;if(typeof t.dataFolderPath!="string")return s.warn("Invalid settings: dataFolderPath is not a string"),!1;if(!t.defaultPlaybackSettings||typeof t.defaultPlaybackSettings!="object")return s.warn("Invalid settings: defaultPlaybackSettings is not an object"),!1;let e=t.defaultPlaybackSettings;return typeof e.volume!="number"||typeof e.playbackSpeed!="number"||typeof e.skipIntroSeconds!="number"?(s.warn("Invalid settings: defaultPlaybackSettings has invalid fields"),!1):typeof t.autoDownload!="boolean"?(s.warn("Invalid settings: autoDownload is not a boolean"),!1):typeof t.enableNotifications!="boolean"?(s.warn("Invalid settings: enableNotifications is not a boolean"),!1):typeof t.maxCacheEpisodes!="number"||t.maxCacheEpisodes<0?(s.warn("Invalid settings: maxCacheEpisodes is invalid"),!1):typeof t.feedUpdateInterval!="number"||t.feedUpdateInterval<0?(s.warn("Invalid settings: feedUpdateInterval is invalid"),!1):!0}getDefaultValue(){return{...g}}async getSettings(){s.methodEntry("SettingsStore","getSettings");let t=await this.load();return s.methodExit("SettingsStore","getSettings"),t}async updateSettings(t){s.methodEntry("SettingsStore","updateSettings"),await this.save(t),s.methodExit("SettingsStore","updateSettings")}async updateSetting(t,e){s.methodEntry("SettingsStore","updateSetting",t);let a=await this.load();a[t]=e,await this.save(a),s.methodExit("SettingsStore","updateSetting")}async getSetting(t){return(await this.load())[t]}async updateDataFolderPath(t){s.methodEntry("SettingsStore","updateDataFolderPath",t),await this.updateSetting("dataFolderPath",(0,B.normalizePath)(t)),s.methodExit("SettingsStore","updateDataFolderPath")}async updateDefaultVolume(t){s.methodEntry("SettingsStore","updateDefaultVolume",t);let e=await this.load();e.defaultPlaybackSettings.volume=Math.max(0,Math.min(1,t)),await this.save(e),s.methodExit("SettingsStore","updateDefaultVolume")}async updateDefaultPlaybackSpeed(t){s.methodEntry("SettingsStore","updateDefaultPlaybackSpeed",t);let e=await this.load();e.defaultPlaybackSettings.playbackSpeed=Math.max(.5,Math.min(3,t)),await this.save(e),s.methodExit("SettingsStore","updateDefaultPlaybackSpeed")}async updateDefaultSkipIntro(t){s.methodEntry("SettingsStore","updateDefaultSkipIntro",t);let e=await this.load();e.defaultPlaybackSettings.skipIntroSeconds=Math.max(0,t),await this.save(e),s.methodExit("SettingsStore","updateDefaultSkipIntro")}async updateDefaultSkipOutro(t){s.methodEntry("SettingsStore","updateDefaultSkipOutro",t);let e=await this.load();e.defaultPlaybackSettings.skipOutroSeconds=Math.max(0,t),await this.save(e),s.methodExit("SettingsStore","updateDefaultSkipOutro")}async updateAutoDownload(t){s.methodEntry("SettingsStore","updateAutoDownload",t),await this.updateSetting("autoDownload",t),s.methodExit("SettingsStore","updateAutoDownload")}async updateMaxCacheEpisodes(t){s.methodEntry("SettingsStore","updateMaxCacheEpisodes",t),await this.updateSetting("maxCacheEpisodes",Math.max(0,t)),s.methodExit("SettingsStore","updateMaxCacheEpisodes")}async updateFeedUpdateInterval(t){s.methodEntry("SettingsStore","updateFeedUpdateInterval",t),await this.updateSetting("feedUpdateInterval",Math.max(0,t)),s.methodExit("SettingsStore","updateFeedUpdateInterval")}async updateNotifications(t){s.methodEntry("SettingsStore","updateNotifications",t),await this.updateSetting("enableNotifications",t),s.methodExit("SettingsStore","updateNotifications")}async resetToDefaults(){s.methodEntry("SettingsStore","resetToDefaults"),await this.save(this.getDefaultValue()),s.methodExit("SettingsStore","resetToDefaults")}async exportSettings(){s.methodEntry("SettingsStore","exportSettings");let t=await this.load();return s.methodExit("SettingsStore","exportSettings"),t}async importSettings(t){if(s.methodEntry("SettingsStore","importSettings"),!this.validate(t))throw new d("Invalid import settings",this.filePath);await this.save(t),s.methodExit("SettingsStore","importSettings")}async loadWithMigration(){s.methodEntry("SettingsStore","loadWithMigration");let t=await this.load(),e={...this.getDefaultValue(),...t,defaultPlaybackSettings:{...g.defaultPlaybackSettings,...t.defaultPlaybackSettings}};return JSON.stringify(t)!==JSON.stringify(e)&&(s.info("Migrating settings to current version"),await this.save(e)),s.methodExit("SettingsStore","loadWithMigration"),e}};var C=class C{constructor(t,e){this.vault=t,this.pathManager=e,this.indexFilePath=e.getFilePath("cache","image-index.json")}async loadIndex(){try{let t=this.vault.adapter;if(!await t.exists(this.indexFilePath))return this.getDefaultIndex();let e=await t.read(this.indexFilePath),a=JSON.parse(e);return this.validateIndex(a)?a:(s.warn("Invalid image cache index, using default"),this.getDefaultIndex())}catch(t){return s.error("Failed to load image cache index",t),this.getDefaultIndex()}}async saveIndex(t){try{let e=JSON.stringify(t,null,2);await this.vault.adapter.write(this.indexFilePath,e)}catch(e){throw s.error("Failed to save image cache index",e),new d("Failed to save image cache index",this.indexFilePath)}}validateIndex(t){return!(!t||typeof t!="object"||!Array.isArray(t.images)||typeof t.version!="number")}getDefaultIndex(){return{images:[],version:C.CURRENT_VERSION}}getImageCacheFilename(t){let e="jpg";try{let o=new URL(t).pathname.match(/\.([a-zA-Z0-9]+)$/);o&&(e=o[1].toLowerCase())}catch(i){}let a=0;for(let i=0;i<t.length;i++){let r=t.charCodeAt(i);a=(a<<5)-a+r,a=a&a}return`image-${Math.abs(a).toString(36)}.${e}`}async getCachedImage(t){s.methodEntry("ImageCacheStore","getCachedImage",t);let a=(await this.loadIndex()).images.find(r=>r.imageUrl===t);return a?await this.vault.adapter.exists(a.localPath)?(s.methodExit("ImageCacheStore","getCachedImage"),a.localPath):(s.warn("Cached image file not found",a.localPath),await this.removeCachedImage(t),s.methodExit("ImageCacheStore","getCachedImage","file missing"),null):(s.methodExit("ImageCacheStore","getCachedImage","not found"),null)}async cacheImage(t,e){s.methodEntry("ImageCacheStore","cacheImage",t);let a=this.getImageCacheFilename(t),i=this.pathManager.getFilePath("cacheImages",a);await this.vault.adapter.writeBinary(i,e);let r=await this.loadIndex();r.images=r.images.filter(n=>n.imageUrl!==t);let o={imageUrl:t,localPath:i,cachedAt:new Date,size:e.byteLength};return r.images.push(o),await this.saveIndex(r),s.methodExit("ImageCacheStore","cacheImage"),i}async removeCachedImage(t){s.methodEntry("ImageCacheStore","removeCachedImage",t);let e=await this.loadIndex(),a=e.images.find(i=>i.imageUrl===t);if(a){try{await this.vault.adapter.remove(a.localPath)}catch(i){s.warn("Failed to delete cached image file",i)}e.images=e.images.filter(i=>i.imageUrl!==t),await this.saveIndex(e)}s.methodExit("ImageCacheStore","removeCachedImage")}async clearAll(){s.methodEntry("ImageCacheStore","clearAll");let t=await this.loadIndex();for(let e of t.images)try{await this.vault.adapter.remove(e.localPath)}catch(a){s.warn(`Failed to delete cached image: ${e.localPath}`,a)}await this.saveIndex(this.getDefaultIndex()),s.methodExit("ImageCacheStore","clearAll")}async getCacheStats(){let t=await this.loadIndex(),e=t.images.reduce((a,i)=>a+i.size,0);return{totalImages:t.images.length,totalSize:e}}async cleanupOldImages(t=100){s.methodEntry("ImageCacheStore","cleanupOldImages",`keepCount=${t}`);let e=await this.loadIndex();if(e.images.length<=t){s.methodExit("ImageCacheStore","cleanupOldImages","nothing to cleanup");return}let a=[...e.images].sort((r,o)=>{let n=new Date(r.cachedAt).getTime();return new Date(o.cachedAt).getTime()-n}),i=a.slice(t);for(let r of i)try{await this.vault.adapter.remove(r.localPath)}catch(o){s.warn(`Failed to delete old image: ${r.localPath}`,o)}e.images=a.slice(0,t),await this.saveIndex(e),s.info(`Cleaned up ${i.length} old cached images`),s.methodExit("ImageCacheStore","cleanupOldImages")}};C.CURRENT_VERSION=1;var O=C;var l=require("obsidian"),E=class extends l.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),this.loadSettings(),t.createEl("h2",{text:"Podcast Player Settings"}),this.addStorageSection(t),this.addPlaybackSection(t),this.addCacheSection(t),this.addSyncSection(t),this.addNotificationSection(t),this.addAdvancedSection(t)}async loadSettings(){this.settings=this.plugin.settings}async saveSettings(){await this.plugin.saveSettings()}addStorageSection(t){t.createEl("h3",{text:"Data Storage"}),new l.Setting(t).setName("Data folder path").setDesc("Folder where podcast data will be stored (relative to vault root)").addText(e=>e.setPlaceholder(".obsidian/plugins/podcast-player/data").setValue(this.settings.dataFolderPath).onChange(async a=>{this.settings.dataFolderPath=a,await this.saveSettings()}))}addPlaybackSection(t){t.createEl("h3",{text:"Default Playback Settings"}),t.createEl("p",{text:"These settings apply to all podcasts by default. Individual podcasts can override these.",cls:"setting-item-description"}),new l.Setting(t).setName("Default volume").setDesc("Default playback volume (0.0 to 1.0)").addSlider(e=>e.setLimits(0,100,5).setValue(this.settings.defaultPlaybackSettings.volume*100).setDynamicTooltip().onChange(async a=>{this.settings.defaultPlaybackSettings.volume=a/100,await this.saveSettings()})),new l.Setting(t).setName("Default playback speed").setDesc("Default playback speed (0.5x to 3.0x)").addSlider(e=>e.setLimits(50,300,5).setValue(this.settings.defaultPlaybackSettings.playbackSpeed*100).setDynamicTooltip().onChange(async a=>{this.settings.defaultPlaybackSettings.playbackSpeed=a/100,await this.saveSettings()})),new l.Setting(t).setName("Skip intro seconds").setDesc("Number of seconds to skip at the beginning of each episode").addText(e=>e.setPlaceholder("0").setValue(String(this.settings.defaultPlaybackSettings.skipIntroSeconds)).onChange(async a=>{let i=parseInt(a,10);!isNaN(i)&&i>=0&&(this.settings.defaultPlaybackSettings.skipIntroSeconds=i,await this.saveSettings())})),new l.Setting(t).setName("Skip outro seconds").setDesc("Number of seconds to skip at the end of each episode").addText(e=>e.setPlaceholder("0").setValue(String(this.settings.defaultPlaybackSettings.skipOutroSeconds||0)).onChange(async a=>{let i=parseInt(a,10);!isNaN(i)&&i>=0&&(this.settings.defaultPlaybackSettings.skipOutroSeconds=i,await this.saveSettings())}))}addCacheSection(t){t.createEl("h3",{text:"Download & Cache"}),new l.Setting(t).setName("Auto download new episodes").setDesc("Automatically download new episodes when feeds are updated").addToggle(e=>e.setValue(this.settings.autoDownload).onChange(async a=>{this.settings.autoDownload=a,await this.saveSettings()})),new l.Setting(t).setName("Maximum cached episodes").setDesc("Maximum number of episodes to keep in cache. Older episodes will be removed.").addText(e=>e.setPlaceholder("50").setValue(String(this.settings.maxCacheEpisodes)).onChange(async a=>{let i=parseInt(a,10);!isNaN(i)&&i>=0&&(this.settings.maxCacheEpisodes=i,await this.saveSettings())}))}addSyncSection(t){t.createEl("h3",{text:"Feed Sync"}),new l.Setting(t).setName("Feed update interval").setDesc("How often to check for new episodes (in minutes)").addDropdown(e=>e.addOption("15","15 minutes").addOption("30","30 minutes").addOption("60","1 hour").addOption("120","2 hours").addOption("360","6 hours").addOption("720","12 hours").addOption("1440","24 hours").setValue(String(this.settings.feedUpdateInterval)).onChange(async a=>{this.settings.feedUpdateInterval=parseInt(a,10),await this.saveSettings()}))}addNotificationSection(t){t.createEl("h3",{text:"Notifications"}),new l.Setting(t).setName("Enable notifications").setDesc("Show notifications for new episodes and playback events").addToggle(e=>e.setValue(this.settings.enableNotifications).onChange(async a=>{this.settings.enableNotifications=a,await this.saveSettings()}))}addAdvancedSection(t){t.createEl("h3",{text:"Advanced"}),new l.Setting(t).setName("Reset to defaults").setDesc("Reset all settings to their default values").addButton(e=>e.setButtonText("Reset").setWarning().onClick(async()=>{confirm("Are you sure you want to reset all settings to defaults? This cannot be undone.")&&(await this.plugin.resetSettings(),this.display(),new l.Notice("Settings reset to defaults"))})),new l.Setting(t).setName("Export settings").setDesc("Export your settings to a JSON file for backup or sharing").addButton(e=>e.setButtonText("Export").onClick(async()=>{await this.exportSettings()})),new l.Setting(t).setName("Import settings").setDesc("Import settings from a JSON file").addButton(e=>e.setButtonText("Import").onClick(async()=>{await this.importSettings()}))}async exportSettings(){try{let t=JSON.stringify(this.settings,null,2),e=new Blob([t],{type:"application/json"}),a=URL.createObjectURL(e),i=document.createElement("a");i.href=a,i.download=`podcast-player-settings-${Date.now()}.json`,i.click(),URL.revokeObjectURL(a),new l.Notice("Settings exported successfully")}catch(t){console.error("Failed to export settings:",t),new l.Notice("Failed to export settings")}}async importSettings(){let t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async e=>{var r;let i=(r=e.target.files)==null?void 0:r[0];if(i)try{let o=await i.text(),n=JSON.parse(o);if(!n.dataFolderPath||!n.defaultPlaybackSettings)throw new Error("Invalid settings file format");this.settings=n,await this.saveSettings(),this.display(),new l.Notice("Settings imported successfully")}catch(o){console.error("Failed to import settings:",o),new l.Notice("Failed to import settings: Invalid file format")}},t.click()}};var U=require("obsidian"),m="podcast-player-view",x=class extends U.ItemView{constructor(e,a){super(e);this.updateInterval=null;this.plugin=a}getViewType(){return m}getDisplayText(){return"Podcast Player"}getIcon(){return"podcast"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("podcast-player-view"),this.playerContentEl=e.createDiv({cls:"podcast-player-content"}),this.renderPlayer(),this.startUpdateInterval()}async onClose(){this.stopUpdateInterval()}renderPlayer(){this.playerContentEl.empty();let e=this.playerContentEl.createDiv({cls:"player-container"});this.renderEpisodeInfo(e),this.renderPlaybackControls(e),this.renderProgressSection(e),this.renderAdvancedControls(e)}renderEpisodeInfo(e){let a=e.createDiv({cls:"episode-info-section"}),i=a.createEl("h3",{text:"No episode playing",cls:"episode-title"}),r=a.createEl("p",{text:"Select a podcast to start",cls:"podcast-name"});a.createDiv({cls:"episode-metadata"}).createSpan({text:"--:--",cls:"episode-duration"})}renderPlaybackControls(e){let a=e.createDiv({cls:"playback-controls-section"}),i=a.createEl("button",{cls:"player-button player-button-prev",attr:{"aria-label":"Previous episode"}});i.innerHTML="\u23EE",i.addEventListener("click",()=>this.handlePrevious());let r=a.createEl("button",{cls:"player-button player-button-skip-back",attr:{"aria-label":"Skip backward 15s"}});r.innerHTML="\u23EA",r.addEventListener("click",()=>this.handleSkipBackward());let o=a.createEl("button",{cls:"player-button player-button-play-pause",attr:{"aria-label":"Play/Pause"}});o.innerHTML="\u25B6\uFE0F",o.addEventListener("click",()=>this.handlePlayPause());let n=a.createEl("button",{cls:"player-button player-button-skip-forward",attr:{"aria-label":"Skip forward 30s"}});n.innerHTML="\u23E9",n.addEventListener("click",()=>this.handleSkipForward());let u=a.createEl("button",{cls:"player-button player-button-next",attr:{"aria-label":"Next episode"}});u.innerHTML="\u23ED",u.addEventListener("click",()=>this.handleNext())}renderProgressSection(e){let a=e.createDiv({cls:"progress-section"}),i=a.createDiv({cls:"time-display"});i.createSpan({text:"0:00",cls:"current-time"}),i.createSpan({text:" / ",cls:"time-separator"}),i.createSpan({text:"0:00",cls:"total-time"});let o=a.createDiv({cls:"progress-bar-container"}).createDiv({cls:"progress-bar"}),n=o.createDiv({cls:"progress-fill"});n.style.width="0%",o.addEventListener("click",u=>this.handleSeek(u,o))}renderAdvancedControls(e){let a=e.createDiv({cls:"advanced-controls-section"}),i=a.createDiv({cls:"volume-control"});i.createSpan({text:"\u{1F50A}",cls:"volume-icon"}),i.createEl("input",{type:"range",cls:"volume-slider",attr:{min:"0",max:"100",value:"100"}}).addEventListener("input",u=>{let P=u.target;this.handleVolumeChange(parseInt(P.value))});let o=a.createDiv({cls:"speed-control"});o.createSpan({text:"Speed:",cls:"speed-label"}),o.createEl("button",{text:"1.0x",cls:"speed-button"}).addEventListener("click",()=>this.handleSpeedChange())}handlePlayPause(){console.log("Play/Pause clicked")}handlePrevious(){console.log("Previous episode clicked")}handleNext(){console.log("Next episode clicked")}handleSkipBackward(){console.log("Skip backward clicked")}handleSkipForward(){console.log("Skip forward clicked")}handleSeek(e,a){let i=a.getBoundingClientRect(),o=(e.clientX-i.left)/i.width*100;console.log(`Seek to ${o.toFixed(2)}%`)}handleVolumeChange(e){console.log(`Volume changed to ${e}%`)}handleSpeedChange(){console.log("Speed change clicked")}startUpdateInterval(){this.updateInterval=window.setInterval(()=>{this.updatePlayerState()},1e3)}stopUpdateInterval(){this.updateInterval!==null&&(window.clearInterval(this.updateInterval),this.updateInterval=null)}updatePlayerState(){}formatTime(e){let a=Math.floor(e/3600),i=Math.floor(e%3600/60),r=Math.floor(e%60);return a>0?`${a}:${i.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`:`${i}:${r.toString().padStart(2,"0")}`}};var I=require("obsidian"),f="podcast-sidebar-view",D=class extends I.ItemView{constructor(e,a){super(e);this.selectedPodcast=null;this.plugin=a}getViewType(){return f}getDisplayText(){return"Podcasts"}getIcon(){return"podcast"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("podcast-sidebar-view"),this.sidebarContentEl=e.createDiv({cls:"podcast-sidebar-content"}),await this.render()}async onClose(){}async render(){this.sidebarContentEl.empty(),this.renderHeader(),this.selectedPodcast?await this.renderEpisodeList():await this.renderPodcastList()}renderHeader(){let e=this.sidebarContentEl.createDiv({cls:"sidebar-header"});if(this.selectedPodcast){let r=e.createEl("button",{cls:"sidebar-back-button",attr:{"aria-label":"Back to podcasts"}});r.innerHTML="\u2190 Back",r.addEventListener("click",()=>{this.selectedPodcast=null,this.render()})}let a=e.createEl("h2",{text:this.selectedPodcast?this.selectedPodcast.title:"My Podcasts",cls:"sidebar-title"}),i=e.createDiv({cls:"sidebar-actions"});if(this.selectedPodcast){let r=i.createEl("button",{cls:"sidebar-action-button",attr:{"aria-label":"Podcast settings"}});r.innerHTML="\u2699\uFE0F",r.addEventListener("click",()=>this.handlePodcastSettings())}else{let r=i.createEl("button",{cls:"sidebar-action-button",attr:{"aria-label":"Subscribe to podcast"}});r.innerHTML="\u2795",r.addEventListener("click",()=>this.handleAddPodcast());let o=i.createEl("button",{cls:"sidebar-action-button",attr:{"aria-label":"Refresh feeds"}});o.innerHTML="\u{1F504}",o.addEventListener("click",()=>this.handleRefreshFeeds())}}async renderPodcastList(){let e=this.sidebarContentEl.createDiv({cls:"podcast-list-container"}),a=[];if(a.length===0){let i=e.createDiv({cls:"empty-state"});i.createEl("p",{text:"No podcasts yet"}),i.createEl("p",{text:"Click the + button to subscribe to a podcast",cls:"empty-state-hint"});return}for(let i of a)this.renderPodcastItem(e,i)}renderPodcastItem(e,a){var n;let i=e.createDiv({cls:"podcast-item"});if(a.imageUrl){let u=i.createEl("img",{cls:"podcast-image",attr:{src:a.imageUrl,alt:a.title}})}else{let u=i.createDiv({cls:"podcast-image-placeholder"});u.innerHTML="\u{1F399}\uFE0F"}let r=i.createDiv({cls:"podcast-info"});r.createEl("h3",{text:a.title,cls:"podcast-title"}),r.createEl("p",{text:a.author,cls:"podcast-author"});let o=((n=a.episodes)==null?void 0:n.length)||0;r.createSpan({text:`${o} episodes`,cls:"podcast-episode-count"}),i.addEventListener("click",()=>{this.selectedPodcast=a,this.render()}),i.addEventListener("contextmenu",u=>{u.preventDefault(),this.showPodcastContextMenu(a,u)})}async renderEpisodeList(){if(!this.selectedPodcast)return;let e=this.sidebarContentEl.createDiv({cls:"episode-list-container"}),a=this.selectedPodcast.episodes||[];if(a.length===0){let i=e.createDiv({cls:"empty-state"});i.createEl("p",{text:"No episodes available"}),i.createEl("p",{text:"Try refreshing the feed",cls:"empty-state-hint"});return}for(let i of a)this.renderEpisodeItem(e,i)}renderEpisodeItem(e,a){let i=e.createDiv({cls:"episode-item"}),r=i.createDiv({cls:"episode-info"});r.createEl("h4",{text:a.title,cls:"episode-title"});let o=r.createDiv({cls:"episode-metadata"}),n=new Date(a.publishDate);o.createSpan({text:n.toLocaleDateString(),cls:"episode-date"}),a.duration&&o.createSpan({text:` \u2022 ${this.formatDuration(a.duration)}`,cls:"episode-duration"});let u=i.createEl("button",{cls:"episode-play-button",attr:{"aria-label":"Play episode"}});u.innerHTML="\u25B6\uFE0F",u.addEventListener("click",P=>{P.stopPropagation(),this.handlePlayEpisode(a)}),i.addEventListener("click",()=>{this.handleEpisodeClick(a)}),i.addEventListener("contextmenu",P=>{P.preventDefault(),this.showEpisodeContextMenu(a,P)})}async handleAddPodcast(){console.log("Add podcast clicked")}async handleRefreshFeeds(){console.log("Refresh feeds clicked")}handlePodcastSettings(){console.log("Podcast settings clicked")}handlePlayEpisode(e){console.log("Play episode:",e.title)}handleEpisodeClick(e){console.log("Episode clicked:",e.title)}showPodcastContextMenu(e,a){let i=new I.Menu;i.addItem(r=>r.setTitle("View Episodes").setIcon("list").onClick(()=>{this.selectedPodcast=e,this.render()})),i.addItem(r=>r.setTitle("Refresh Feed").setIcon("refresh-cw").onClick(()=>{console.log("Refresh feed:",e.title)})),i.addSeparator(),i.addItem(r=>r.setTitle("Unsubscribe").setIcon("trash").onClick(()=>{console.log("Unsubscribe:",e.title)})),i.showAtMouseEvent(a)}showEpisodeContextMenu(e,a){let i=new I.Menu;i.addItem(r=>r.setTitle("Play").setIcon("play").onClick(()=>this.handlePlayEpisode(e))),i.addItem(r=>r.setTitle("Add to Queue").setIcon("list-plus").onClick(()=>{console.log("Add to queue:",e.title)})),i.addItem(r=>r.setTitle("Add to Playlist").setIcon("folder-plus").onClick(()=>{console.log("Add to playlist:",e.title)})),i.addSeparator(),i.addItem(r=>r.setTitle("Export to Note").setIcon("file-text").onClick(()=>{console.log("Export to note:",e.title)})),i.showAtMouseEvent(a)}formatDuration(e){let a=Math.floor(e/3600),i=Math.floor(e%3600/60);return a>0?`${a}h ${i}m`:`${i}m`}async loadPodcasts(){return[]}async refresh(){await this.render()}};var F=class extends y.Plugin{async onload(){s.info("Loading Podcast Player plugin"),this.pathManager=new S(this.app.vault,g.dataFolderPath),this.settingsStore=new b(this.app.vault,this.pathManager),await this.loadSettings(),this.registerView(m,t=>new x(t,this)),this.registerView(f,t=>new D(t,this)),this.addSettingTab(new E(this.app,this)),this.addRibbonIcon("podcast","Podcast Player",async t=>{await this.activateSidebarView()}),this.addCommand({id:"open-podcast-player",name:"Open Podcast Player",callback:async()=>{await this.activatePlayerView()}}),this.addCommand({id:"open-podcast-sidebar",name:"Open Podcast Sidebar",callback:async()=>{await this.activateSidebarView()}}),this.addCommand({id:"subscribe-to-podcast",name:"Subscribe to Podcast",callback:()=>{new y.Notice("Subscribe to Podcast - Coming Soon!")}}),s.info("Podcast Player plugin loaded successfully")}onunload(){s.info("Unloading Podcast Player plugin"),this.app.workspace.detachLeavesOfType(m),this.app.workspace.detachLeavesOfType(f)}async loadSettings(){s.methodEntry("PodcastPlayerPlugin","loadSettings");try{this.settings=await this.settingsStore.loadWithMigration(),this.pathManager.updateBasePath(this.settings.dataFolderPath),s.info("Settings loaded successfully")}catch(t){s.error("Failed to load settings, using defaults",t),this.settings={...g}}s.methodExit("PodcastPlayerPlugin","loadSettings")}async saveSettings(){s.methodEntry("PodcastPlayerPlugin","saveSettings");try{await this.settingsStore.updateSettings(this.settings),this.pathManager.updateBasePath(this.settings.dataFolderPath),s.info("Settings saved successfully")}catch(t){s.error("Failed to save settings",t),new y.Notice("Failed to save settings")}s.methodExit("PodcastPlayerPlugin","saveSettings")}async resetSettings(){s.methodEntry("PodcastPlayerPlugin","resetSettings");try{await this.settingsStore.resetToDefaults(),this.settings={...g},this.pathManager.updateBasePath(this.settings.dataFolderPath),s.info("Settings reset to defaults")}catch(t){s.error("Failed to reset settings",t),new y.Notice("Failed to reset settings")}s.methodExit("PodcastPlayerPlugin","resetSettings")}async activatePlayerView(){s.methodEntry("PodcastPlayerPlugin","activatePlayerView");let{workspace:t}=this.app,e=null,a=t.getLeavesOfType(m);a.length>0?e=a[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:m,active:!0})),e&&t.revealLeaf(e),s.methodExit("PodcastPlayerPlugin","activatePlayerView")}async activateSidebarView(){s.methodEntry("PodcastPlayerPlugin","activateSidebarView");let{workspace:t}=this.app,e=null,a=t.getLeavesOfType(f);a.length>0?e=a[0]:(e=t.getRightLeaf(!1),e&&await e.setViewState({type:f,active:!0})),e&&t.revealLeaf(e),s.methodExit("PodcastPlayerPlugin","activateSidebarView")}};
